<% pageTitle = 'Reports' %>
<div class="reports-page">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Community Condition Reports</h1>
    <% if (locals.user) { %>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addReportModal">
            + Submit New Report
        </button>
    <% } %>
</div>

<!-- filter -->
<form method="POST" action="/reports" class="mb-4">
    <div class="row g-2 align-items-end">
  
      <!-- Resort filter -->
      <div class="col-md-4">
        <label for="resortSelect" class="form-label">Resort</label>
        <select id="resortSelect" name="resort_id" class="form-select">
          <option value="" <%= !locals.selectedResortId ? 'selected' : '' %>>All resorts</option>
          <% if (locals.resorts && resorts.length) { %>
            <% resorts.forEach(r => { %>
              <option 
                value="<%= r.resort_id %>" 
                <%= locals.selectedResortId 
                    && String(locals.selectedResortId) === String(r.resort_id)
                    ? 'selected' 
                    : '' %>>
                <%= r.resort_name %>
              </option>
            <% }) %>
          <% } %>
        </select>
      </div>
  
      <!-- Area filter -->
      <div class="col-md-4">
        <label for="areaSelect" class="form-label">Area</label>
        <select id="areaSelect" name="area_id" class="form-select">
          <option value="" <%= !locals.selectedAreaId ? 'selected' : '' %>>All areas</option>
          <% if (locals.areas && areas.length) { %>
            <% areas.forEach(a => { %>
              <option 
                value="<%= a.area_id %>" 
                <%= locals.selectedAreaId 
                    && String(locals.selectedAreaId) === String(a.area_id)
                    ? 'selected' 
                    : '' %>>
                <%= a.area_name %>
              </option>
            <% }) %>
          <% } %>
        </select>
      </div>
  
      <!-- Run filter -->
      <div class="col-md-4">
        <label for="runSelect" class="form-label">Run</label>
        <select id="runSelect" name="run_id" class="form-select">
          <option value="" <%= !locals.selectedRunId ? 'selected' : '' %>>All runs</option>
          <% if (locals.runs && runs.length) { %>
            <% runs.forEach(run => { %>
              <option 
                value="<%= run.run_id %>" 
                <%= locals.selectedRunId 
                    && String(locals.selectedRunId) === String(run.run_id)
                    ? 'selected' 
                    : '' %>>
                <%= run.run_name %>
              </option>
            <% }) %>
          <% } %>
        </select>
      </div>
  
    </div>
  
    <div class="mt-3">
      <button type="submit" class="btn btn-primary">Filter Reports</button>
    </div>
  </form>

  <!-- filter scripts -->
  <script>
    const resortSelect = document.getElementById('resortSelect');
    const areaSelect = document.getElementById('areaSelect');
    const runSelect = document.getElementById('runSelect');
  
    function resetAreaSelect() {
      areaSelect.innerHTML = `
        <option value="">All areas</option>
      `;
    }
  
    function resetRunSelect() {
      runSelect.innerHTML = `
        <option value="">All runs</option>
      `;
    }
  
    async function loadAreasForResort(resortId) {
      resetAreaSelect();
      resetRunSelect(); // clear runs too because resort changed
  
      if (!resortId) return; // if "All resorts", nothing else to load
  
      try {
        const res = await fetch(`/api/resorts/${resortId}/areas`);
        if (!res.ok) return;
        const areas = await res.json();
  
        areas.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.area_id;
          opt.textContent = a.area_name;
          areaSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading areas for resort', resortId, err);
      }
    }
  
    async function loadRunsForArea(areaId) {
      resetRunSelect();
  
      if (!areaId) return; // if "All areas", nothing more to load
  
      try {
        const res = await fetch(`/api/areas/${areaId}/runs`);
        if (!res.ok) return;
        const runs = await res.json();
  
        runs.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.run_id;
          opt.textContent = r.run_name;
          runSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading runs for area', areaId, err);
      }
    }
  
    resortSelect.addEventListener('change', () => {
      const resortId = resortSelect.value || null;
      loadAreasForResort(resortId);
    });
  
    areaSelect.addEventListener('change', () => {
      const areaId = areaSelect.value || null;
      loadRunsForArea(areaId);
    });
  </script>

<% if (locals.reports && reports.length) { %>
    <div class="list-group">
    <h2>Latest Hazards & Conditions</h2>
    
        <% reports.forEach(report => { %>
            <div class="list-group-item list-group-item-action flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1"><%= report.run_name || 'Run ID ' + report.run_id %></h5>
                    <small class="text-muted"><%= new Date(report.date_reported).toLocaleString() %></small>
                </div>
                <p class="mb-1">
                    <strong>Reported by:</strong> <%= report.username || 'Anonymous' %>
                    <br>
                    <strong>Status:</strong> 
                    <% if (report.obstacle) { %>
                        <span class="badge bg-info me-1">Obstacle</span>
                    <% } %>
                    <% if (report.groomed) { %>
                        <span class="badge bg-info me-1">Groomed</span>
                    <% } %>
                    <% if (report.icy) { %>
                        <span class="badge bg-info me-1">Icy</span>
                    <% } %>
                    <% if (report.powder) { %>
                        <span class="badge bg-info me-1">Powder</span>
                    <% } %>
                    <% if (report.moguls) { %>
                        <span class="badge bg-info me-1">Moguls</span>
                    <% } %>
                    <% if (report.granular) { %>
                        <span class="badge bg-info me-1">Granular</span>
                    <% } %>
                    <% if (report.thin_cover) { %>
                        <span class="badge bg-info me-1">Thin Cover</span>
                    <% } %>
                    <% if (report.packed) { %>
                        <span class="badge bg-info me-1">Packed</span>
                    <% } %>
                    <% if (report.wet) { %>
                        <span class="badge bg-info me-1">Wet</span>
                    <% } %>
                </p>
                <small><%= report.description %></small>
            </div>
        <% }); %>
    </div>
<% } else { %>
    <div class="alert alert-info text-center">
        No community reports have been submitted yet.
    </div>
<% } %>

<!-- <div class="modal fade" id="addReportModal" tabindex="-1" aria-labelledby="addReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReportModalLabel">Submit Condition Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/reports/<%= locals.user.user_id %>" method="POST">
                    <div class="mb-3">
                        <label for="resortSelect" class="form-label">Select Resort</label>
                        <select class="form-select" id="resortSelect">
                            <option value="">Choose a resort</option>
                            <% resorts.forEach(r => { %>
                                <option value="<%= r.id %>"><%= r.name %></option>
                            <% }) %>
                        </select>
                        <label for="areaSelect_id" class="form-label">Select Area</label>
                        <select class="form-select" id="areaSelect">
                            <option value="">Choose a resort first</option>
                        </select>
                        <label for="runSelect" class="form-label">Select Run</label>
                        <select class="form-select" id="runSelect">
                            <option value="">Choose an area first</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conditions/Hazards</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="obstacle" name="obstacle" value="true">
                                <label class="form-check-label" for="obstacle">Obstacle</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="groomed" name="groomed" value="true">
                                <label class="form-check-label" for="groomed">Groomed</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="icy" name="icy" value="true">
                                <label class="form-check-label" for="icy">Icy</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="powder" name="powder" value="true">
                                <label class="form-check-label" for="powder">Powder</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="moguls" name="moguls" value="true">
                                <label class="form-check-label" for="moguls">Moguls</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="granular" name="granular" value="true">
                                <label class="form-check-label" for="granular">Granular</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="thin_cover" name="thin_cover" value="true">
                                <label class="form-check-label" for="thin_cover">Thin Cover</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="packed" name="packed" value="true">
                                <label class="form-check-label" for="packed">Packed</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="wet" name="wet" value="true">
                                <label class="form-check-label" for="wet">Wet</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="closed" name="closed" value="true">
                                <label class="form-check-label" for="closed">Closed</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning">Submit Report</button>
                </form>
            </div>
        </div>
    </div>
</div> -->

<!-- modal -->
<div class="modal fade" id="addReportModal" tabindex="-1" aria-labelledby="addReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addReportModalLabel">Submit Condition Report</h5>
          <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
          <form action="/reports/<%= locals.user.user_id %>" method="POST">
            <div class="mb-3">
              <!-- RESORT -->
              <label for="modalResortSelect" class="form-label">Select Resort</label>
                <select
                class="form-select"
                id="modalResortSelect"
                name="resort_id"
                required
                >
                <option value="">Choose a resort</option>
                <% resorts.forEach(r => { %>
                  <option value="<%= r.resort_id %>"><%= r.resort_name %></option>
                <% }) %>
              </select>
  
              <!-- AREA -->
              <label for="modalAreaSelect" class="form-label mt-2">Select Area</label>
                <select
                class="form-select"
                id="modalAreaSelect"
                name="area_id"
                required
                >
                <option value="">Choose a resort first</option>
              </select>
  
              <!-- RUN -->
              <label for="modalRunSelect" class="form-label mt-2">Select Run</label>
                <select
                class="form-select"
                id="modalRunSelect"
                name="run_id"
                required
                >
                <option value="">Choose an area first</option>
              </select>
            </div>
  
            <div class="mb-3">
              <label class="form-label">Conditions/Hazards</label>
              <div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="obstacle" name="obstacle" value="true">
                  <label class="form-check-label" for="obstacle">Obstacle</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="groomed" name="groomed" value="true">
                  <label class="form-check-label" for="groomed">Groomed</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="icy" name="icy" value="true">
                  <label class="form-check-label" for="icy">Icy</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="powder" name="powder" value="true">
                    <label class="form-check-label" for="powder">Powder</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="moguls" name="moguls" value="true">
                    <label class="form-check-label" for="moguls">Moguls</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="granular" name="granular" value="true">
                    <label class="form-check-label" for="granular">Granular</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="thin_cover" name="thin_cover" value="true">
                    <label class="form-check-label" for="thin_cover">Thin Cover</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="packed" name="packed" value="true">
                    <label class="form-check-label" for="packed">Packed</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="wet" name="wet" value="true">
                    <label class="form-check-label" for="wet">Wet</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="closed" name="closed" value="true">
                    <label class="form-check-label" for="closed">Closed</label>
                </div>
              </div>
            </div>
  
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea
                class="form-control"
                id="description"
                name="description"
                rows="3"
              ></textarea>
            </div>
  
            <button type="submit" class="btn btn-warning">Submit Report</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- modal script -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
      // ðŸ‘‰ Target MODAL selects, not the filter selects
      const resortSelect = document.getElementById('modalResortSelect');
      const areaSelect   = document.getElementById('modalAreaSelect');
      const runSelect    = document.getElementById('modalRunSelect');
  
      if (!resortSelect || !areaSelect || !runSelect) {
        console.warn('Report modal selects not found on this page');
        return;
      }
  
      async function loadAreasForResort(resortId) {
        // Reset area and run selects
        areaSelect.innerHTML = '<option value="">Choose a resort first</option>';
        runSelect.innerHTML = '<option value="">Choose an area first</option>';
        
        if (!resortId) return;
  
        try {
          const res = await fetch(`/api/resorts/${resortId}/areas`);
          if (!res.ok) {
            areaSelect.innerHTML = '<option value="">Error loading areas</option>';
            return;
          }
          const areas = await res.json();
  
          if (!areas.length) {
            areaSelect.innerHTML = '<option value="">No areas for this resort</option>';
            return;
          }
  
          areaSelect.innerHTML = '<option value="">Choose an area</option>';
          areas.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.area_id;
            opt.textContent = a.area_name;
            areaSelect.appendChild(opt);
          });
        } catch (err) {
          console.error('Error loading areas for resort', resortId, err);
          areaSelect.innerHTML = '<option value="">Error loading areas</option>';
        }
      }
  
      async function loadRunsForArea(areaId) {
        // Reset run select
        runSelect.innerHTML = '<option value="">Choose an area first</option>';
        
        if (!areaId) return;
  
        try {
          const res = await fetch(`/api/areas/${areaId}/runs`);
          if (!res.ok) {
            runSelect.innerHTML = '<option value="">Error loading runs</option>';
            return;
          }
          const runs = await res.json();
  
          if (!runs.length) {
            runSelect.innerHTML = '<option value="">No runs for this area</option>';
            return;
          }
  
          runSelect.innerHTML = '<option value="">Choose a run</option>';
          runs.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.run_id;
            opt.textContent = r.run_name;
            runSelect.appendChild(opt);
          });
        } catch (err) {
          console.error('Error loading runs for area', areaId, err);
          runSelect.innerHTML = '<option value="">Error loading runs</option>';
        }
      }
  
      resortSelect.addEventListener('change', function () {
        const resortId = this.value || null;
        loadAreasForResort(resortId);
      });
  
      areaSelect.addEventListener('change', function () {
        const areaId = this.value || null;
        loadRunsForArea(areaId);
      });
    });
  </script>