<% pageTitle = 'Reports' %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Community Condition Reports</h1>
    <% if (locals.user) { %>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addReportModal">
            + Submit New Report
        </button>
    <% } %>
</div>

<h2>Latest Hazards & Conditions</h2>

<% if (locals.reports && reports.length) { %>
    <div class="list-group">
        <% reports.forEach(report => { %>
            <div class="list-group-item list-group-item-action flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1"><%= report.slope_name || 'Slope ID ' + report.slope_id %></h5>
                    <small class="text-muted"><%= new Date(report.created_time).toLocaleString() %></small>
                </div>
                <p class="mb-1">
                    <strong>Reported by:</strong> <%= report.username || 'Anonymous' %>
                    <br>
                    <strong>Status:</strong> 
                    <% if (report.obstacle) { %>
                        <span class="badge bg-danger me-1">Obstacle</span>
                    <% } %>
                    <% if (report.groomed) { %>
                        <span class="badge bg-danger me-1">Groomed</span>
                    <% } %>
                    <% if (report.icy) { %>
                        <span class="badge bg-danger me-1">Icy</span>
                    <% } %>
                    <% if (report.powder) { %>
                        <span class="badge bg-info me-1">Powder</span>
                    <% } %>
                    <% if (report.moguls) { %>
                        <span class="badge bg-dark me-1">Moguls</span>
                    <% } %>
                    <% if (report.granular) { %>
                        <span class="badge bg-danger me-1">Granular</span>
                    <% } %>
                    <% if (report.thin_cover) { %>
                        <span class="badge bg-danger me-1">Thin Cover</span>
                    <% } %>
                    <% if (report.packed) { %>
                        <span class="badge bg-danger me-1">Packed</span>
                    <% } %>
                    <% if (report.wet) { %>
                        <span class="badge bg-danger me-1">Wet</span>
                    <% } %>
                </p>
                <small><%= report.description %></small>
                <% if (locals.user && (user.user_id === report.user_id || user.role === 'Admin')) { %>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-warning">Edit</button>
                        <form action="/reports/<%= report.report_id %>?_method=DELETE" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </div>
                <% } %>
            </div>
        <% }); %>
    </div>
<% } else { %>
    <div class="alert alert-info text-center">
        No community reports have been submitted yet.
    </div>
<% } %>

<div class="modal fade" id="addReportModal" tabindex="-1" aria-labelledby="addReportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReportModalLabel">Submit Condition Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/reports/<%= locals.user.user_id %>" method="POST">
                    <div class="mb-3">
                        <label for="slope_id" class="form-label">Select Slope/Run</label>
                        <select class="form-select" id="slope_id" name="slope_id" required>
                            <option value="">--Select and option--</option>
                            <% runs.forEach(run => { %>
                                <option value="<%= run.run_name %>"> <%= run.run_name %></option>
                            <% }); %>
                            </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conditions/Hazards</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="obstacle" name="obstacle" value="true">
                                <label class="form-check-label" for="obstacle">Obstacle</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="groomed" name="groomed" value="true">
                                <label class="form-check-label" for="groomed">Groomed</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="icy" name="icy" value="true">
                                <label class="form-check-label" for="icy">Icy</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="powder" name="powder" value="true">
                                <label class="form-check-label" for="powder">Powder</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="moguls" name="moguls" value="true">
                                <label class="form-check-label" for="moguls">Moguls</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="granular" name="granular" value="true">
                                <label class="form-check-label" for="granular">Granular</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="thin_cover" name="thin_cover" value="true">
                                <label class="form-check-label" for="thin_cover">Thin Cover</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="packed" name="packed" value="true">
                                <label class="form-check-label" for="packed">Packed</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="wet" name="wet" value="true">
                                <label class="form-check-label" for="wet">Wet</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="closed" name="closed" value="true">
                                <label class="form-check-label" for="closed">Closed</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning">Submit Report</button>
                </form>
            </div>
        </div>
    </div>
</div>